'use strict';

/**
 *  Module dependencies.
 */

var http = require('http');
var path = require('path');
var koa  = require('koa');

var wares  = require('./app/middleware');
var session = require('./app/common/session');
var config = require('./config');

var app = koa();
app.keys = ['Star Trek', config.sessionSecret];
app.proxy = true;
app.outputErrors = true;

app.use(wares.static(
  __dirname + '/public',
  { maxAge: config.debug ? 0 : 60 * 60 * 24 * 7 }
));
app.use(wares.bodyParser());
app.use(wares.methodOverride());
app.use(session);

app = http.createServer(app.callback());

if (!module.parent) {
  app.listen(config.port);
}

module.exports = app;
